## FSM and VM in PostgreSQL (Very Important DBA Topic)

These two are **internal storage maps** that help PostgreSQL work efficiently with **MVCC and VACUUM**.

---

## 1Ô∏è‚É£ FSM ‚Äì Free Space Map

### What is FSM?

> **FSM tracks free space available in table pages so PostgreSQL knows where new rows can fit.**

Instead of scanning the whole table, PostgreSQL consults FSM.

---

### Why FSM is needed

* MVCC creates **dead tuples**
* VACUUM frees space **inside pages**
* FSM remembers **which pages have free space**

Without FSM ‚Üí slow inserts & table scans.

---

### How FSM works

* One FSM file per table
* Tracks approximate free space per page
* Not exact ‚Üí only a hint

---

### Example (real life)

1. Large DELETE happens
2. VACUUM removes dead tuples
3. Space becomes free inside pages
4. FSM marks those pages
5. New INSERTs reuse that space

‚û° Prevents table growth.

---

### FSM file location

```
$PGDATA/base/<db_oid>/<relfilenode>_fsm
```

---

## 2Ô∏è‚É£ VM ‚Äì Visibility Map

### What is VM?

> **VM tracks which table pages are visible to all transactions and/or fully frozen.**

This helps:

* VACUUM skip pages
* Index-only scans work

---

### What VM stores (2 bits per page)

| VM bit      | Meaning                          |
| ----------- | -------------------------------- |
| All-visible | Page visible to all transactions |
| All-frozen  | Page fully frozen (no XID risk)  |

---

### Why VM is needed

#### üîπ Faster VACUUM

* VACUUM skips all-visible pages
* Saves I/O

#### üîπ Index-only scans

* If page is all-visible ‚Üí no heap fetch
* Huge performance gain

---

### VM file location

```
$PGDATA/base/<db_oid>/<relfilenode>_vm
```

---

## 3Ô∏è‚É£ FSM vs VM (Interview table)

| Feature    | FSM              | VM               |
| ---------- | ---------------- | ---------------- |
| Purpose    | Track free space | Track visibility |
| Used by    | INSERT / UPDATE  | VACUUM / SELECT  |
| Updated by | VACUUM           | VACUUM           |
| Improves   | Space reuse      | Query speed      |
| Related to | Storage          | MVCC             |

---

## 4Ô∏è‚É£ Relation with VACUUM & MVCC

### VACUUM:

* Cleans dead tuples
* Updates **FSM** (free space info)
* Updates **VM** (visibility info)

### MVCC:

* Creates dead tuples
* Requires VACUUM
* FSM & VM make MVCC efficient

---

## 5Ô∏è‚É£ What happens if FSM/VM is missing or outdated?

* PostgreSQL rebuilds them automatically
* Worst case ‚Üí slower performance
* No data loss

---

## 6Ô∏è‚É£ Practical DBA commands

### Check index-only scan usage

```sql
SELECT relname, idx_scan, idx_tup_fetch
FROM pg_stat_user_indexes;
```

High `idx_scan` and low `idx_tup_fetch` ‚Üí VM working well.

---

### Check vacuum progress

```sql
SELECT * FROM pg_stat_progress_vacuum;
```

---

## 7Ô∏è‚É£ Interview one-liners (memorize)

* **FSM:** ‚ÄúTracks where free space exists in tables.‚Äù
* **VM:** ‚ÄúTracks which pages are visible to all transactions.‚Äù
* ‚ÄúVACUUM maintains both FSM and VM.‚Äù

---

## üîë Final takeaway

* FSM ‚Üí **space reuse**
* VM ‚Üí **visibility & speed**
* Both are **critical for performance**
* Maintained automatically by VACUUM

---


