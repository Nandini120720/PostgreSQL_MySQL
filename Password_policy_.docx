CREATE DATABASE IF NOT EXISTS admin_db;
USE admin_db;


CALL admin_db.create_user_with_policy('sampleuser', 'localhost', 'simple');

DROP PROCEDURE IF EXISTS create_user_with_policy;

-----------
DELIMITER $$
CREATE PROCEDURE create_user_with_policy(
    IN in_username VARCHAR(50),
    IN in_userhost VARCHAR(50),
    IN in_userpass VARCHAR(100)
)
BEGIN
    DECLARE pass_len INT DEFAULT 0;
    DECLARE has_upper, has_lower, has_digit, has_special INT DEFAULT 0;
    DECLARE full_password_ok INT DEFAULT 0;

    -- Check password length
    SET pass_len = LENGTH(in_userpass);

    -- Check for character types using REGEXP
    IF pass_len >= 12 THEN
        IF in_userpass REGEXP '[A-Z]' THEN SET has_upper = 1; END IF;
        IF in_userpass REGEXP '[a-z]' THEN SET has_lower = 1; END IF;
        IF in_userpass REGEXP '[0-9]' THEN SET has_digit = 1; END IF;
        IF in_userpass REGEXP '[!@#$%^&*(),.?":{}|<>]' THEN SET has_special = 1; END IF;
    END IF;

    -- Final check
    SET full_password_ok = has_upper + has_lower + has_digit + has_special;

    IF pass_len >= 12 AND full_password_ok = 4 THEN
        -- Check if user already exists
        SET @user_check_query := CONCAT(
            "SELECT COUNT(*) INTO @exists FROM mysql.user WHERE user = '",
            in_username, "' AND host = '", in_userhost, "'"
        );
        PREPARE stmt_check FROM @user_check_query;
        EXECUTE stmt_check;
        DEALLOCATE PREPARE stmt_check;

        IF @exists = 0 THEN
            -- Create user only, no GRANT
            SET @create_user := CONCAT(
                "CREATE USER '", in_username, "'@'", in_userhost,
                "' IDENTIFIED BY '", in_userpass, "'"
            );
            PREPARE stmt_create FROM @create_user;
            EXECUTE stmt_create;
            DEALLOCATE PREPARE stmt_create;

            SELECT CONCAT(" User '", in_username, "'@'", in_userhost, "' created successfully.") AS status;
        ELSE
            SELECT CONCAT(" User '", in_username, "'@'", in_userhost, "' already exists.") AS status;
        END IF;

    ELSE
        SELECT ' Password policy failed: Minimum 12 characters, must include uppercase, lowercase, digit, and special character.' AS error;
    END IF;
END$$

-- Reset delimiter
DELIMITER ;

